
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>单元测试 · 简明 ASP.NET Core 手册</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Nate Barbettini">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-disqus/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="integration-testing.html" />
    
    
    <link rel="prev" href="./" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../your-first-application/">
            
                <a href="../your-first-application/">
            
                    
                    你的第一个程序
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.2.1" data-path="../your-first-application/get-the-sdk.html">
            
                <a href="../your-first-application/get-the-sdk.html">
            
                    
                    获取 SDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.2" data-path="../your-first-application/hello-world-in-csharp.html">
            
                <a href="../your-first-application/hello-world-in-csharp.html">
            
                    
                    C# 版的 Hello World
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2.3" data-path="../your-first-application/create-aspnetcore-project.html">
            
                <a href="../your-first-application/create-aspnetcore-project.html">
            
                    
                    创建一个 ASP.NET Core 项目
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="../mvc-basics/">
            
                <a href="../mvc-basics/">
            
                    
                    MVC 基础
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../mvc-basics/create-controller.html">
            
                <a href="../mvc-basics/create-controller.html">
            
                    
                    创建控制器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../mvc-basics/create-models.html">
            
                <a href="../mvc-basics/create-models.html">
            
                    
                    创建模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../mvc-basics/create-view.html">
            
                <a href="../mvc-basics/create-view.html">
            
                    
                    创建视图
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.4" data-path="../mvc-basics/add-service-class.html">
            
                <a href="../mvc-basics/add-service-class.html">
            
                    
                    添加一个服务类
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.5" data-path="../mvc-basics/use-dependency-injection.html">
            
                <a href="../mvc-basics/use-dependency-injection.html">
            
                    
                    运用依赖注入
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.6" data-path="../mvc-basics/finish-controller.html">
            
                <a href="../mvc-basics/finish-controller.html">
            
                    
                    完成控制器
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="../add-external-packages/">
            
                <a href="../add-external-packages/">
            
                    
                    添加外来软件包
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="../use-a-database/">
            
                <a href="../use-a-database/">
            
                    
                    运用数据库
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="../use-a-database/connect-to-a-database.html">
            
                <a href="../use-a-database/connect-to-a-database.html">
            
                    
                    连接数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="../use-a-database/update-context.html">
            
                <a href="../use-a-database/update-context.html">
            
                    
                    修改数据库上下文
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="../use-a-database/create-migration.html">
            
                <a href="../use-a-database/create-migration.html">
            
                    
                    创建变更
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="../use-a-database/create-service-class.html">
            
                <a href="../use-a-database/create-service-class.html">
            
                    
                    创建服务类
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="../add-more-features/">
            
                <a href="../add-more-features/">
            
                    
                    添加新特性
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../add-more-features/add-todo-items.html">
            
                <a href="../add-more-features/add-todo-items.html">
            
                    
                    添加 待办事项 条目
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../add-more-features/complete-with-checkbox.html">
            
                <a href="../add-more-features/complete-with-checkbox.html">
            
                    
                    使用复选框标记条目完成
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="../security-and-identity/">
            
                <a href="../security-and-identity/">
            
                    
                    安全和身份
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../security-and-identity/add-facebook-login.html">
            
                <a href="../security-and-identity/add-facebook-login.html">
            
                    
                    添加 Facebook 登录功能
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../security-and-identity/require-authentication.html">
            
                <a href="../security-and-identity/require-authentication.html">
            
                    
                    提示认证
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../security-and-identity/using-identity-in-the-application.html">
            
                <a href="../security-and-identity/using-identity-in-the-application.html">
            
                    
                    在程序中使用身份
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../security-and-identity/authorization-with-roles.html">
            
                <a href="../security-and-identity/authorization-with-roles.html">
            
                    
                    按角色进行授权
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="./">
            
                <a href="./">
            
                    
                    自动化测试
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.8.1" data-path="unit-testing.html">
            
                <a href="unit-testing.html">
            
                    
                    单元测试
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="integration-testing.html">
            
                <a href="integration-testing.html">
            
                    
                    集成测试
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../deploy-the-application/">
            
                <a href="../deploy-the-application/">
            
                    
                    部署程序
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.9.1" data-path="../deploy-the-application/deploy-to-azure.html">
            
                <a href="../deploy-the-application/deploy-to-azure.html">
            
                    
                    部署到 Azure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.9.2" data-path="../deploy-the-application/deploy-with-docker.html">
            
                <a href="../deploy-the-application/deploy-with-docker.html">
            
                    
                    使用 Docker 进行部署
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.10" data-path="../conclusion/">
            
                <a href="../conclusion/">
            
                    
                    结束语
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >单元测试</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="&#x5355;&#x5143;&#x6D4B;&#x8BD5;"><a name="&#x5355;&#x5143;&#x6D4B;&#x8BD5;" class="plugin-anchor" href="#&#x5355;&#x5143;&#x6D4B;&#x8BD5;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5355;&#x5143;&#x6D4B;&#x8BD5;</h2>
<p>&#x5355;&#x5143;&#x6D4B;&#x8BD5;&#x662F;&#x5C0F;&#x578B;&#x3001;&#x8FC5;&#x901F;&#xFF0C;&#x9488;&#x5BF9;&#x5355;&#x4E2A;&#x65B9;&#x6CD5;&#x6216;&#x8005;&#x903B;&#x8F91;&#x5757;&#x7684;&#x6D4B;&#x8BD5;&#x3002;&#x5B83;&#x5E76;&#x4E0D;&#x6D4B;&#x8BD5;&#x4E00;&#x7EC4;&#x7C7B;&#x6216;&#x8005;&#xFF08;&#x50CF;&#x96C6;&#x6210;&#x6D4B;&#x8BD5;&#x90A3;&#x6837;&#xFF09;&#x6D4B;&#x8BD5;&#x6574;&#x4E2A;&#x7CFB;&#x7EDF;&#xFF0C;&#x5355;&#x5143;&#x6D4B;&#x8BD5;&#x4F9D;&#x8D56;&#x4E8E; <strong>&#x865A;&#x6784;(mocking)</strong> &#x6216;&#x8005;&#x66FF;&#x6362;&#x5F53;&#x524D;&#x88AB;&#x6D4B;&#x8BD5;&#x65B9;&#x6CD5;&#x6240;&#x4F9D;&#x8D56;&#x7684;&#x5BF9;&#x8C61;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF0C;<code>TodoController</code> &#x6709;&#x4E24;&#x4E2A;&#x4F9D;&#x8D56;&#xFF1A; <code>ITodoItemService</code> &#x548C; <code>UserManager</code>&#x3002;<code>TodoItemService</code> &#x63A5;&#x4E0B;&#x6765;&#x53C8;&#x4F9D;&#x8D56;&#x4E8E; <code>ApplicationDbContext</code>&#x3002;&#xFF08;&#x4F60;&#x53EF;&#x4EE5;&#x753B;&#x4E00;&#x6761;&#x7EBF;&#x8868;&#x793A; <code>TodoController</code> -&gt; <code>TodoItemService</code> -&gt; <code>ApplicationDbContext</code>&#xFF0C;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x88AB;&#x79F0;&#x4E3A; <strong>&#x4F9D;&#x8D56;&#x56FE;</strong>&#xFF09;&#x3002;</p>
<p>&#x5F53;&#x7A0B;&#x5E8F;&#x8FD0;&#x8F6C;&#x6B63;&#x5E38;&#x7684;&#x65F6;&#x5019;&#xFF0C; ASP.NET Core &#x7684;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#x7CFB;&#x7EDF;&#x5728; <code>TodoController</code> &#x6216;&#x8005; <code>TodoItemService</code> &#x88AB;&#x521B;&#x5EFA;&#x65F6;&#x628A;&#x8FD9;&#x4E9B;&#x5BF9;&#x8C61;&#x9010;&#x4E00;&#x5730;&#x6CE8;&#x5165;&#x5230;&#x4F9D;&#x8D56;&#x56FE;&#x91CC;&#x3002;</p>
<p>&#x53E6;&#x4E00;&#x65B9;&#x9762;&#xFF0C;&#x5F53;&#x4F60;&#x5199;&#x5355;&#x5143;&#x6D4B;&#x8BD5;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x624B;&#x52A8;&#x6CE8;&#x5165;&#x8FD9;&#x4E9B;&#x4F9D;&#x8D56;&#x7684;&#x865A;&#x6784;&#x7684;&#x6216;&#x8005;&#x6D4B;&#x8BD5;&#x7248;&#x672C;&#x3002;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x4F60;&#x53EF;&#x4EE5;&#x628A;&#x6B63;&#x5728;&#x6D4B;&#x8BD5;&#x7684;&#x7C7B;&#x6216;&#x8005;&#x65B9;&#x6CD5;&#x7684;&#x903B;&#x8F91;&#x9694;&#x79BB;&#x51FA;&#x6765;&#x3002;&#xFF08;&#x5982;&#x679C;&#x4F60;&#x5728;&#x6D4B;&#x8BD5;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#xFF0C;&#x663E;&#x7136;&#x4E0D;&#x5E94;&#x8BE5;&#x4E00;&#x5931;&#x624B;&#x5199;&#x5230;&#x6570;&#x636E;&#x5E93;&#x91CC;&#x53BB;&#x3002;&#xFF09;</p>
<h3 id="&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x9879;&#x76EE;"><a name="&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x9879;&#x76EE;" class="plugin-anchor" href="#&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x9879;&#x76EE;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x9879;&#x76EE;</h3>
<p>&#x4E3A;&#x6D4B;&#x8BD5;&#x521B;&#x5EFA;&#x72EC;&#x7ACB;&#x7684;&#x9879;&#x76EE;&#x662F;&#x4E00;&#x4E2A;&#x5E38;&#x89C1;&#x7684;&#x505A;&#x6CD5;&#xFF0C;&#x4EE5;&#x4FDD;&#x6301;&#x9879;&#x76EE;&#x6574;&#x6D01;&#x5E76;&#x6709;&#x6761;&#x7406;&#x3002;&#x65B0;&#x7684;&#x6D4B;&#x8BD5;&#x9879;&#x76EE;&#x5E94;&#x8BE5;&#x88AB;&#x7F6E;&#x4E8E;&#x4F60;&#x4E3B;&#x9879;&#x76EE;&#x7684;&#x540C;&#x7EA7;&#x76EE;&#x5F55;&#xFF08;&#x800C;&#x975E;&#x5728;&#x4E3B;&#x9879;&#x76EE;&#x76EE;&#x5F55;&#x5185;&#xFF09;&#x3002;</p>
<p>&#x5982;&#x679C;&#x4F60;&#x5F53;&#x524D;&#x5728;&#x4F60;&#x9879;&#x76EE;&#x76EE;&#x5F55;&#x91CC;&#xFF0C;&#x5411;&#x4E0A; <code>cd</code> &#x4E00;&#x5C42;&#x3002;&#xFF08;&#x8FD9;&#x4E2A;&#x76EE;&#x5F55;&#x4E5F;&#x53EB;&#x505A; <code>AspNetCoreTodo</code>&#xFF09;&#x3002;&#x7136;&#x540E;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x642D;&#x5EFA;&#x51FA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x6D4B;&#x8BD5;&#x9879;&#x76EE;&#xFF1A;</p>
<pre><code>mkdir AspNetCoreTodo.UnitTests
cd AspNetCoreTodo.UnitTests
dotnet new xunit
</code></pre><p>xUnit.NET &#x662F;&#x4E00;&#x4E2A;&#x5E38;&#x7528;&#x7684;&#x9488;&#x5BF9; .NET &#x4EE3;&#x7801;&#x7684;&#x6D4B;&#x8BD5;&#x6846;&#x67B6;&#xFF0C;&#x53EF;&#x7528;&#x4E8E;&#x7F16;&#x5199;&#x5355;&#x5143;&#x548C;&#x96C6;&#x6210;&#x6D4B;&#x8BD5;&#x3002;&#x50CF;&#x5176;&#x5B83;&#x7EC4;&#x4EF6;&#x4E00;&#x6837;&#xFF0C;&#x5B83;&#x4E5F;&#x662F;&#x4E00;&#x7EC4;&#x53EF;&#x88AB;&#x5B89;&#x88C5;&#x5728;&#x4EFB;&#x610F;&#x9879;&#x76EE;&#x4E2D;&#x7684; NuGet &#x5305;&#x3002;<code>dotnet new xunit</code> &#x5DF2;&#x7ECF;&#x5305;&#x62EC;&#x4E86;&#x4F60;&#x6240;&#x9700;&#x7684;&#x4E00;&#x5207;&#x3002;</p>
<p>&#x4F60;&#x7684;&#x76EE;&#x5F55;&#x7ED3;&#x6784;&#x770B;&#x8D77;&#x6765;&#x5E94;&#x8BE5;&#x662F;&#x8FD9;&#x6837;&#xFF1A;</p>
<pre><code>AspNetCoreTodo/
    AspNetCoreTodo/
        AspNetCoreTodo.csproj
        Controllers/
        (etc...)

    AspNetCoreTodo.UnitTests/
        AspNetCoreTodo.UnitTests.csproj
</code></pre><p>&#x65E2;&#x7136;&#x6D4B;&#x8BD5;&#x9879;&#x76EE;&#x8981;&#x4F7F;&#x7528;&#x4F60;&#x4E3B;&#x9879;&#x76EE;&#x4E2D;&#x7684;&#x7C7B;&#xFF0C;&#x4F60;&#x9700;&#x8981;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x5F15;&#x7528;&#x6307;&#x5411;&#x4E3B;&#x9879;&#x76EE;&#xFF1A;</p>
<pre><code>dotnet add reference ../AspNetCoreTodo/AspNetCoreTodo.csproj
</code></pre><p>&#x5220;&#x9664;&#x81EA;&#x52A8;&#x521B;&#x5EFA;&#x7684;&#x6587;&#x4EF6; <code>UnitTest1.cs</code>&#x3002;&#x4F60;&#x5DF2;&#x7ECF;&#x4E3A;&#x7B2C;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x7684;&#x7F16;&#x5199;&#x51C6;&#x5907;&#x5C31;&#x7EEA;&#x4E86;&#x3002;</p>
<h3 id="&#x5199;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x6D4B;&#x8BD5;"><a name="&#x5199;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x6D4B;&#x8BD5;" class="plugin-anchor" href="#&#x5199;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x6D4B;&#x8BD5;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5199;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x6D4B;&#x8BD5;</h3>
<p>&#x770B;&#x4E00;&#x4E0B; <code>TodoItemService</code> &#x91CC;&#x9762;&#x7684; <code>AddItemAsync</code> &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">bool</span>&gt; <span class="hljs-title">AddItemAsync</span>(<span class="hljs-params">NewTodoItem newItem, ApplicationUser user</span>)
</span>{
    <span class="hljs-keyword">var</span> entity = <span class="hljs-keyword">new</span> TodoItem
    {
        Id = Guid.NewGuid(),
        OwnerId = user.Id,
        IsDone = <span class="hljs-keyword">false</span>,
        Title = newItem.Title,
        DueAt = DateTimeOffset.Now.AddDays(<span class="hljs-number">3</span>)
    };

    _context.Items.Add(entity);

    <span class="hljs-keyword">var</span> saveResult = <span class="hljs-keyword">await</span> _context.SaveChangesAsync();
    <span class="hljs-keyword">return</span> saveResult == <span class="hljs-number">1</span>;
}
</code></pre>
<p>&#x8BE5;&#x65B9;&#x6CD5;&#x5728;&#x628A;&#x65B0;&#x6761;&#x76EE;&#x771F;&#x6B63;&#x5B58;&#x5165;&#x6570;&#x636E;&#x5E93;&#x4E4B;&#x524D;&#xFF0C;&#x505A;&#x4E86;&#x591A;&#x4E2A;&#x5224;&#x65AD;&#x4E0E;&#x5047;&#x8BBE;&#xFF1A;</p>
<ul>
<li><code>OwnerId</code> &#x5C5E;&#x6027;&#x5E94;&#x8BE5;&#x88AB;&#x8BBE;&#x7F6E;&#x4E3A;&#x7528;&#x6237;&#x7684; ID</li>
<li>&#x65B0;&#x6761;&#x76EE;&#x5E94;&#x8BE5;&#x603B;&#x662F;&#x672A;&#x5B8C;&#x6210;&#x72B6;&#x6001;&#xFF08;<code>IsDone = false</code>&#xFF09;</li>
<li>&#x65B0;&#x6761;&#x76EE;&#x7684;&#x6807;&#x9898;&#x5E94;&#x8BE5;&#x590D;&#x5236;&#x81EA; <code>newItem.Title</code></li>
<li>&#x65B0;&#x6761;&#x76EE;&#x5E94;&#x8BE5;&#x603B;&#x662F;&#x4ECE;&#x73B0;&#x5728;&#x5F00;&#x59CB;3&#x5929;&#x540E;&#x8FC7;&#x671F;</li>
</ul>
<blockquote>
<p>&#x4F60;&#x4EE3;&#x7801;&#x505A;&#x51FA;&#x7684;&#x8FD9;&#x4E9B;&#x5224;&#x65AD;&#x88AB;&#x79F0;&#x4E3A; <em>&#x4E1A;&#x52A1;&#x903B;&#x8F91;(business logic)</em>&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x662F;&#x8DDF;&#x4F60;&#x7A0B;&#x5E8F;&#x7684;&#x76EE;&#x6807;&#x6216;&#x8005;&#x53EB;&#x201C;&#x4E1A;&#x52A1;&#x201D;&#x76F8;&#x5173;&#x7684;&#x903B;&#x8F91;&#x3002;&#x5176;&#x5B83;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x7684;&#x4F8B;&#x5B50;&#x5305;&#x62EC;&#x201C;&#x57FA;&#x4E8E;&#x4EA7;&#x54C1;&#x4EF7;&#x683C;&#x548C;&#x7A0E;&#x7387;&#x8BA1;&#x7B97;&#x51FA;&#x603B;&#x4EF7;&#x201D;&#x548C;&#x201C;&#x5728;&#x6E38;&#x620F;&#x91CC;&#x68C0;&#x67E5;&#x4E00;&#x4E2A;&#x73A9;&#x5BB6;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x6709;&#x8DB3;&#x591F;&#x5347;&#x7EA7;&#x7684;&#x7ECF;&#x9A8C;&#x70B9;&#x201D;&#x3002;</p>
</blockquote>
<p>&#x8FD9;&#x4E9B;&#x5224;&#x65AD;&#x5F88;&#x5408;&#x7406;&#xFF0C;&#x5E76;&#x4E14;&#x540C;&#x6837;&#x5408;&#x7406;&#x7684;&#x662F;&#xFF1A;&#x5199;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x4EE5;&#x786E;&#x4FDD;&#x8FD9;&#x4E9B;&#x903B;&#x8F91;&#x4E0D;&#x4F1A;&#x8131;&#x8F68;&#x3002;&#xFF08;&#x8BBE;&#x60F3;&#x4F60;&#x6216;&#x8005;&#x522B;&#x7684;&#x4EC0;&#x4E48;&#x4EBA;&#x91CD;&#x6784;&#x4E86; <code>AddItemAsync</code> &#x65B9;&#x6CD5;&#xFF0C;&#x4F46;&#x662F;&#x5374;&#x6F0F;&#x6389;&#x4E86;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x5224;&#x65AD;&#x3002;&#x5F53;&#x4F60;&#x7684;&#x670D;&#x52A1;&#x5F88;&#x7B80;&#x5355;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8FD9;&#x53EF;&#x80FD;&#x4E0D;&#x4F1A;&#x53D1;&#x751F;&#xFF0C;&#x4F46;&#x5728;&#x7A0B;&#x5E8F;&#x65E5;&#x76CA;&#x590D;&#x6742;&#x8D77;&#x6765;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x81EA;&#x52A8;&#x5316;&#x8FD9;&#x4E9B;&#x6D4B;&#x8BD5;&#x5C31;&#x53D8;&#x5F97;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x4E86;&#x3002;&#xFF09;</p>
<p>&#x5199;&#x4E00;&#x4E2A;&#x5355;&#x5143;&#x6D4B;&#x8BD5;&#x6765;&#x68C0;&#x9A8C; <code>TodoItemService</code> &#x91CC;&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x5728;&#x4F60;&#x7684;&#x6D4B;&#x8BD5;&#x9879;&#x76EE;&#x91CC;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x7C7B;&#xFF1A;</p>
<p><strong><code>AspNetCoreTodo.UnitTests/TodoItemServiceShould.cs</code></strong></p>
<pre><code class="lang-csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> AspNetCoreTodo.Data;
<span class="hljs-keyword">using</span> AspNetCoreTodo.Models;
<span class="hljs-keyword">using</span> AspNetCoreTodo.Services;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;
<span class="hljs-keyword">using</span> Xunit;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">AspNetCoreTodo.UnitTests</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TodoItemServiceShould</span>
    {
        [Fact]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AddNewItem</span>(<span class="hljs-params"></span>)
        </span>{
            <span class="hljs-comment">// ...</span>
        }
    }
}
</code></pre>
<p><code>[Fact]</code> &#x5C5E;&#x6027;&#x662F; xUnit.NET &#x5305;&#x91CC;&#x5E26;&#x6765;&#x7684;&#xFF0C;&#x5B83;&#x628A;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x6807;&#x8BB0;&#x4E3A;&#x4E00;&#x4E2A;&#x6D4B;&#x8BD5;&#x65B9;&#x6CD5;&#x3002;</p>
<blockquote>
<p>&#x6709;&#x5F88;&#x591A;&#x4E0D;&#x540C;&#x7684;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x547D;&#x540D;&#x548C;&#x7EC4;&#x7EC7;&#x6D4B;&#x8BD5;&#xFF0C;&#x5B83;&#x4EEC;&#x90FD;&#x6709;&#x7740;&#x5404;&#x81EA;&#x7684;&#x4F18;&#x7F3A;&#x70B9;&#x3002;&#x6211;&#x559C;&#x6B22;&#x7ED9;&#x6D4B;&#x8BD5;&#x7C7B;&#x52A0;&#x4E0A; <code>Should</code> &#x524D;&#x7F00;&#xFF0C;&#x4F7F;&#x65B9;&#x6CD5;&#x540D;&#x6784;&#x6210;&#x4E00;&#x4E2A;&#x53EF;&#x8BFB;&#x6027;&#x826F;&#x597D;&#x7684;&#x53E5;&#x5B50;&#xFF0C;&#x4E0D;&#x8FC7;&#x4F60;&#x53EF;&#x4EE5;&#x6309;&#x81EA;&#x5DF1;&#x7684;&#x610F;&#x613F;&#x9009;&#x62E9;&#x547D;&#x540D;&#x98CE;&#x683C;&#x3002;</p>
</blockquote>
<p><code>TodoItemService</code> &#x9700;&#x8981;&#x4E00;&#x4E2A; <code>ApplicationDbContext</code>&#xFF0C;&#x540E;&#x8005;&#x901A;&#x5E38;&#x8FDE;&#x63A5;&#x5230;&#x4F60;&#x7684;&#x5F00;&#x53D1;&#x6216;&#x751F;&#x4EA7;&#x73AF;&#x5883;&#x91CC;&#x7684;&#x6570;&#x636E;&#x5E93;&#x3002;&#x4F60;&#x4E0D;&#x8BE5;&#x628A;&#x8FD9;&#x4E9B;&#x6570;&#x636E;&#x5E93;&#x7528;&#x4E8E;&#x6D4B;&#x8BD5;&#x3002;&#x76F8;&#x53CD;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x5728;&#x6D4B;&#x8BD5;&#x4EE3;&#x7801;&#x91CC;&#x4F7F;&#x7528; Entity Framework Core &#x7684;&#x5185;&#x5B58;&#x6570;&#x636E;&#x5E93;&#x7684; provider&#x3002;&#x56E0;&#x4E3A;&#x6574;&#x4E2A;&#x6570;&#x636E;&#x5E93;&#x90FD;&#x5B58;&#x5728;&#x4E8E;&#x5185;&#x5B58;&#x91CC;&#xFF0C;&#x6BCF;&#x6B21;&#x6D4B;&#x91CD;&#x65B0;&#x5F00;&#x59CB;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4ED6;&#x5C31;&#x4F1A;&#x88AB;&#x6E05;&#x7A7A;&#x3002;&#x5E76;&#x4E14;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x662F;&#x4E2A;&#x5408;&#x4E4E;&#x89C4;&#x683C;&#x7684; Entity Framework Core &#x7684; provider&#xFF0C;<code>TodoItemService</code> &#x4E0D;&#x4F1A;&#x5BDF;&#x89C9;&#x6709;&#x4EC0;&#x4E48;&#x5F02;&#x6837;&#x3002;</p>
<p>&#x7528;&#x4E00;&#x4E2A; <code>DbContextOptionsBuilder</code> &#x6765;&#x914D;&#x7F6E;&#x5185;&#x5B58;&#x6570;&#x636E;&#x5E93;&#x7684; provider&#xFF0C;&#x7136;&#x540E;&#x5BF9; <code>AddItem</code> &#x53D1;&#x8D77;&#x4E00;&#x4E2A;&#x8C03;&#x7528;&#xFF1A;</p>
<pre><code class="lang-csharp"><span class="hljs-keyword">var</span> options = <span class="hljs-keyword">new</span> DbContextOptionsBuilder&lt;ApplicationDbContext&gt;()
    .UseInMemoryDatabase(databaseName: <span class="hljs-string">&quot;Test_AddNewItem&quot;</span>).Options;

<span class="hljs-comment">// Set up a context (connection to the DB) for writing</span>
<span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> inMemoryContext = <span class="hljs-keyword">new</span> ApplicationDbContext(options))
{
    <span class="hljs-keyword">var</span> service = <span class="hljs-keyword">new</span> TodoItemService(inMemoryContext);

    <span class="hljs-keyword">var</span> fakeUser = <span class="hljs-keyword">new</span> ApplicationUser
    {
        Id = <span class="hljs-string">&quot;fake-000&quot;</span>,
        UserName = <span class="hljs-string">&quot;fake@fake&quot;</span>
    };

    <span class="hljs-keyword">await</span> service.AddItemAsync(<span class="hljs-keyword">new</span> NewTodoItem { Title = <span class="hljs-string">&quot;Testing?&quot;</span> }, fakeUser);
}
</code></pre>
<p>&#x6700;&#x540E;&#x4E00;&#x884C;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x65B0;&#x7684;&#x540D;&#x4E3A; <code>Testing?</code> &#x7684;&#x5F85;&#x529E;&#x4E8B;&#x9879;&#xFF0C;&#x5E76;&#x901A;&#x77E5;&#x670D;&#x52A1;&#x5C06;&#x5176;&#x5B58;&#x50A8;&#x5230;&#xFF08;&#x5185;&#x5B58;&#xFF09;&#x6570;&#x636E;&#x5E93;&#x91CC;&#x3002;&#x4E3A;&#x9A8C;&#x8BC1;&#x4E1A;&#x52A1;&#x903B;&#x8F91;&#x6267;&#x884C;&#x7684;&#x6B63;&#x786E;&#x6027;&#xFF0C;&#x53D6;&#x51FA;&#x8FD9;&#x4E2A;&#x6761;&#x76EE;&#xFF1A;</p>
<pre><code class="lang-csharp"><span class="hljs-comment">// Use a separate context to read the data back from the DB</span>
<span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> inMemoryContext = <span class="hljs-keyword">new</span> ApplicationDbContext(options))
{
    Assert.Equal(<span class="hljs-number">1</span>, <span class="hljs-keyword">await</span> inMemoryContext.Items.CountAsync());

    <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> inMemoryContext.Items.FirstAsync();
    Assert.Equal(<span class="hljs-string">&quot;Testing?&quot;</span>, item.Title);
    Assert.Equal(<span class="hljs-keyword">false</span>, item.IsDone);
    Assert.True(DateTimeOffset.Now.AddDays(<span class="hljs-number">3</span>) - item.DueAt &lt; TimeSpan.FromSeconds(<span class="hljs-number">1</span>));
}
</code></pre>
<p>&#x7B2C;&#x4E00;&#x4E2A;&#x9A8C;&#x8BC1;&#x6B65;&#x9AA4;&#x662F;&#x4E2A;&#x660E;&#x667A;&#x7684;&#x68C0;&#x67E5;&#xFF1A;&#x5185;&#x5B58;&#x6570;&#x636E;&#x5E93;&#x91CC;&#x4FDD;&#x5B58;&#x7684;&#x6761;&#x76EE;&#x7EDD;&#x4E0D;&#x4F1A;&#x8D85;&#x8FC7;&#x4E00;&#x6761;&#x3002;&#x5047;&#x8BBE;&#x8FD9;&#x4E2A;&#x68C0;&#x67E5;&#x901A;&#x8FC7;&#x4E86;&#xFF0C;&#x6D4B;&#x8BD5;&#x4F1A;&#x4F7F;&#x7528; <code>FirstAsync</code> &#x65B9;&#x6CD5;&#x53D6;&#x51FA;&#x5B58;&#x50A8;&#x7684;&#x6761;&#x76EE;&#xFF0C;&#x7136;&#x540E;&#x65AD;&#x8A00;&#x5176;&#x4E2D;&#x7684;&#x5C5E;&#x6027;&#x88AB;&#x8BBE;&#x7F6E;&#x4E86;&#x9884;&#x671F;&#x7684;&#x503C;&#x3002;</p>
<p>&#x65AD;&#x8A00;&#x4E00;&#x4E2A;&#x65E5;&#x671F;&#x65F6;&#x95F4;&#x503C;&#x6709;&#x70B9;&#x68D8;&#x624B;&#xFF0C;&#x56E0;&#x4E3A;&#x6BD4;&#x8F83;&#x4E24;&#x4E2A;&#x65E5;&#x671F;&#x503C;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5C31;&#x7B97;&#x662F;&#x53EA;&#x6709;&#x6BEB;&#x79D2;&#x90E8;&#x5206;&#x4E0D;&#x540C;&#xFF0C;&#x4E24;&#x4E2A;&#x503C;&#x4E5F;&#x662F;&#x4E0D;&#x7B49;&#x7684;&#x3002;&#x66FF;&#x4EE3;&#x65B9;&#x6848;&#x662F;&#xFF0C;&#x68C0;&#x67E5; <code>DueAt</code> &#x7684;&#x503C;&#x8DDD;&#x79BB;&#x671F;&#x671B;&#x503C;&#x5C0F;&#x4E8E;&#x4E00;&#x79D2;&#x3002;</p>
<blockquote>
<p>&#x4E0D;&#x8BBA;&#x662F;&#x5355;&#x5143;&#x6D4B;&#x8BD5;&#x8FD8;&#x662F;&#x96C6;&#x6210;&#x6D4B;&#x8BD5;&#xFF0C;&#x90FD;&#x9075;&#x5FAA; AAA&#xFF08;&#x5E03;&#x7F6E;-&#x6267;&#x884C;-&#x65AD;&#x8A00;&#x2014;&#x2014;Arrange-Act-Assert&#xFF09;&#x6A21;&#x5F0F;&#xFF1A;&#x5BF9;&#x8C61;&#x548C;&#x6570;&#x636E;&#x9996;&#x5148;&#x88AB;&#x5EFA;&#x7ACB;&#x51FA;&#x6765;&#xFF0C;&#x7136;&#x540E;&#x6267;&#x884C;&#x4E00;&#x4E9B;&#x52A8;&#x4F5C;&#xFF0C;&#x6700;&#x540E;&#x6D4B;&#x8BD5;&#x7A0B;&#x5E8F;&#x68C0;&#x67E5;&#xFF08;&#x65AD;&#x8A00;&#xFF09;&#x9884;&#x671F;&#x8868;&#x73B0;&#x7684;&#x5B58;&#x5728;&#x3002;</p>
</blockquote>
<p>&#x8FD9;&#x662F; <code>AddNewItem</code> &#x6D4B;&#x8BD5;&#x7684;&#x6700;&#x7EC8;&#x7248;&#x672C;&#xFF1A;</p>
<p><strong><code>AspNetCoreTodo.UnitTests/TodoItemServiceShould.cs</code></strong></p>
<pre><code class="lang-csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TodoItemServiceShould</span>
{
    [Fact]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AddNewItem</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">new</span> DbContextOptionsBuilder&lt;ApplicationDbContext&gt;()
            .UseInMemoryDatabase(databaseName: <span class="hljs-string">&quot;Test_AddNewItem&quot;</span>)
            .Options;

        <span class="hljs-comment">// Set up a context (connection to the DB) for writing</span>
        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> inMemoryContext = <span class="hljs-keyword">new</span> ApplicationDbContext(options))
        {
            <span class="hljs-keyword">var</span> service = <span class="hljs-keyword">new</span> TodoItemService(inMemoryContext);
            <span class="hljs-keyword">await</span> service.AddItemAsync(<span class="hljs-keyword">new</span> NewTodoItem { Title = <span class="hljs-string">&quot;Testing?&quot;</span> }, <span class="hljs-keyword">null</span>);
        }

        <span class="hljs-comment">// Use a separate context to read the data back from the DB</span>
        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> inMemoryContext = <span class="hljs-keyword">new</span> ApplicationDbContext(options))
        {
            Assert.Equal(<span class="hljs-number">1</span>, <span class="hljs-keyword">await</span> inMemoryContext.Items.CountAsync());

            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> inMemoryContext.Items.FirstAsync();
            Assert.Equal(<span class="hljs-string">&quot;Testing?&quot;</span>, item.Title);
            Assert.Equal(<span class="hljs-keyword">false</span>, item.IsDone);
            Assert.True(DateTimeOffset.Now.AddDays(<span class="hljs-number">3</span>) - item.DueAt &lt; TimeSpan.FromSeconds(<span class="hljs-number">1</span>));
        }
    }
}
</code></pre>
<h3 id="&#x8FD0;&#x884C;&#x6D4B;&#x8BD5;"><a name="&#x8FD0;&#x884C;&#x6D4B;&#x8BD5;" class="plugin-anchor" href="#&#x8FD0;&#x884C;&#x6D4B;&#x8BD5;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x8FD0;&#x884C;&#x6D4B;&#x8BD5;</h3>
<p>&#x5728;&#x7EC8;&#x7AEF;&#x7A97;&#x53E3;&#xFF0C;&#x8FD0;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#xFF08;&#x8BF7;&#x786E;&#x4FDD;&#x4F60;&#x4F4D;&#x4E8E; <code>AspNetCoreTodo.UnitTests</code> &#x76EE;&#x5F55;&#xFF09;&#xFF1A;</p>
<pre><code>dotnet test
</code></pre><p><code>test</code> &#x547D;&#x4EE4;&#x5728;&#x5F53;&#x524D;&#x7684;&#x9879;&#x76EE;&#x91CC;&#x67E5;&#x627E;&#x6D4B;&#x8BD5;&#x65B9;&#x6CD5;&#xFF08;&#x672C;&#x4F8B;&#x4E2D;&#xFF0C;&#x7531; <code>[Fact]</code> &#x5C5E;&#x6027;&#x6807;&#x8BB0;&#x51FA;&#x6765;&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x8FD0;&#x884C;&#x5B83;&#x627E;&#x5230;&#x7684;&#x6240;&#x6709;&#x6D4B;&#x8BD5;&#xFF0C;&#x4F60;&#x4F1A;&#x770B;&#x5230;&#x7C7B;&#x4F3C;&#x8FD9;&#x6837;&#x7684;&#x8F93;&#x51FA;&#xFF1A;</p>
<pre><code>Starting test execution, please wait...
[xUnit.net 00:00:00.7595476]   Discovering: AspNetCoreTodo.UnitTests
[xUnit.net 00:00:00.8511683]   Discovered:  AspNetCoreTodo.UnitTests
[xUnit.net 00:00:00.9222450]   Starting:    AspNetCoreTodo.UnitTests
[xUnit.net 00:00:01.3862430]   Finished:    AspNetCoreTodo.UnitTests

Total tests: 1. Passed: 1. Failed: 0. Skipped: 0.
Test Run Successful.
Test execution time: 1.9074 Seconds
</code></pre><p>&#x4F60;&#x73B0;&#x5728;&#x6709;&#x4E86;&#x6D4B;&#x8BD5;&#x7A0B;&#x5E8F;&#xFF0C;&#x8986;&#x76D6;&#x4E86; <code>TodoItemService</code> &#x7684;&#x6D4B;&#x8BD5;&#x8303;&#x56F4;&#x3002;&#x4F5C;&#x4E3A;&#x4E00;&#x4E2A;&#x8865;&#x5145;&#x7EC3;&#x4E60;&#xFF0C;&#x8BF7;&#x5199;&#x51FA;&#x5355;&#x5143;&#x6D4B;&#x8BD5;&#x4EE5;&#x786E;&#x4FDD;&#xFF1A;</p>
<ul>
<li>&#x5982;&#x679C;&#x4F20;&#x5165;&#x4E00;&#x4E2A;&#x4E0D;&#x5B58;&#x5728;&#x7684; ID&#xFF0C; <code>MarkDoneAsync</code> &#x8FD4;&#x56DE; false</li>
<li>&#x5F53;&#x4E00;&#x4E2A;&#x6709;&#x6548;&#x7684;&#x6761;&#x76EE;&#x88AB;&#x6807;&#x8BB0;&#x4E3A;&#x5B8C;&#x6210;&#x72B6;&#x6001;&#xFF0C; <code>MarkDoneAsync</code> &#x8FD4;&#x56DE; true</li>
<li><code>GetIncompleteItemsAsync</code> &#x53EA;&#x8FD4;&#x56DE;&#x67D0;&#x4E2A;&#x7279;&#x5B9A;&#x7528;&#x6237;&#x7684;&#x6761;&#x76EE;</li>
</ul>
<hr>
<h2 id="unit-testing"><a name="unit-testing" class="plugin-anchor" href="#unit-testing"><i class="fa fa-link" aria-hidden="true"></i></a>Unit testing</h2>
<p>Unit tests are small, quick tests that check the behavior of a single method or chunk of logic. Instead of testing a whole group of classes, or the entire system (as integration tests do), unit tests rely on <strong>mocking</strong> or replacing the objects the method-under-test depends on.</p>
<p>For example, the <code>TodoController</code> has two dependencies: an <code>ITodoItemService</code> and the <code>UserManager</code>. The <code>TodoItemService</code>, in turn, depends on the <code>ApplicationDbContext</code>. (The idea that you can draw a line from <code>TodoController</code> -&gt; <code>TodoItemService</code> -&gt; <code>ApplicationDbContext</code> is called a <em>dependency graph</em>).</p>
<p>When the application runs normally, the ASP.NET Core dependency injection system injects each of those objects into the dependency graph when the <code>TodoController</code> or the <code>TodoItemService</code> is created.</p>
<p>When you write a unit test, on the other hand, you&apos;ll manually inject mock or test-only versions of those dependencies. This means you can isolate just the logic in the class or method you are testing. (If you&apos;re testing a service, you don&apos;t want to also be accidentally writing to your database!)</p>
<h3 id="create-a-test-project"><a name="create-a-test-project" class="plugin-anchor" href="#create-a-test-project"><i class="fa fa-link" aria-hidden="true"></i></a>Create a test project</h3>
<p>It&apos;s a common practice to create a separate project for your tests, to keep things clean and organized. The new test project should live in a directory that&apos;s next to (not inside) your main project&apos;s directory.</p>
<p>If you&apos;re currently in your project directory, <code>cd</code> up one level. (This directory will also be called <code>AspNetCoreTodo</code>). Then use these commands to scaffold a new test project:</p>
<pre><code>mkdir AspNetCoreTodo.UnitTests
cd AspNetCoreTodo.UnitTests
dotnet new xunit
</code></pre><p>xUnit.NET is a popular test framework for .NET code that can be used to write both unit and integration tests. Like everything else, it&apos;s a set of NuGet packages that can be installed in any project. The <code>dotnet new xunit</code> template already includes everything you need.</p>
<p>Your directory structure should now look like this:</p>
<pre><code>AspNetCoreTodo/
    AspNetCoreTodo/
        AspNetCoreTodo.csproj
        Controllers/
        (etc...)

    AspNetCoreTodo.UnitTests/
        AspNetCoreTodo.UnitTests.csproj
</code></pre><p>Since the test project will use the classes defined in your main project, you&apos;ll need to add a reference to the main project:</p>
<pre><code>dotnet add reference ../AspNetCoreTodo/AspNetCoreTodo.csproj
</code></pre><p>Delete the <code>UnitTest1.cs</code> file that&apos;s automatically created. You&apos;re ready to write your first test.</p>
<h3 id="write-a-service-test"><a name="write-a-service-test" class="plugin-anchor" href="#write-a-service-test"><i class="fa fa-link" aria-hidden="true"></i></a>Write a service test</h3>
<p>Take a look at the logic in the <code>AddItemAsync</code> method of the <code>TodoItemService</code>:</p>
<pre><code class="lang-csharp"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task&lt;<span class="hljs-keyword">bool</span>&gt; <span class="hljs-title">AddItemAsync</span>(<span class="hljs-params">NewTodoItem newItem, ApplicationUser user</span>)
</span>{
    <span class="hljs-keyword">var</span> entity = <span class="hljs-keyword">new</span> TodoItem
    {
        Id = Guid.NewGuid(),
        OwnerId = user.Id,
        IsDone = <span class="hljs-keyword">false</span>,
        Title = newItem.Title,
        DueAt = DateTimeOffset.Now.AddDays(<span class="hljs-number">3</span>)
    };

    _context.Items.Add(entity);

    <span class="hljs-keyword">var</span> saveResult = <span class="hljs-keyword">await</span> _context.SaveChangesAsync();
    <span class="hljs-keyword">return</span> saveResult == <span class="hljs-number">1</span>;
}
</code></pre>
<p>This method makes a number of decisions or assumptions about the new item before it actually saves it to the database:</p>
<ul>
<li>The <code>OwnerId</code> property should be set to the user&apos;s ID</li>
<li>New items should always be incomplete (<code>IsDone = false</code>)</li>
<li>The title of the new item should be copied from <code>newItem.Title</code></li>
<li>New items should always be due 3 days from now</li>
</ul>
<blockquote>
<p>These types of decisions made by your code are called <em>business logic</em>, because it&apos;s logic that relates to the purpose or &quot;business&quot; of your application. Other examples of business logic include things like calculating a total cost based on product prices and tax rates, or checking whether a player has enough points to level up in a game.</p>
</blockquote>
<p>These decisions make sense, and it also makes sense to have a test that ensures that this logic doesn&apos;t change down the road. (Imagine if you or someone else refactored the <code>AddItemAsync</code> method and forgot about one of these assumptions. It might be unlikely when your services are simple, but it becomes important to have automated checks as your application becomes more complicated.)</p>
<p>To write a unit test that will verify the logic in the <code>TodoItemService</code>, create a new class in your test project:</p>
<p><strong><code>AspNetCoreTodo.UnitTests/TodoItemServiceShould.cs</code></strong></p>
<pre><code class="lang-csharp"><span class="hljs-keyword">using</span> System;
<span class="hljs-keyword">using</span> System.Threading.Tasks;
<span class="hljs-keyword">using</span> AspNetCoreTodo.Data;
<span class="hljs-keyword">using</span> AspNetCoreTodo.Models;
<span class="hljs-keyword">using</span> AspNetCoreTodo.Services;
<span class="hljs-keyword">using</span> Microsoft.EntityFrameworkCore;
<span class="hljs-keyword">using</span> Xunit;

<span class="hljs-keyword">namespace</span> <span class="hljs-title">AspNetCoreTodo.UnitTests</span>
{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TodoItemServiceShould</span>
    {
        [Fact]
        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AddNewItem</span>(<span class="hljs-params"></span>)
        </span>{
            <span class="hljs-comment">// ...</span>
        }
    }
}
</code></pre>
<p>The <code>[Fact]</code> attribute comes from the xUnit.NET package, and it marks this method as a test method.</p>
<blockquote>
<p>There are many different ways of naming and organizing tests, all with different pros and cons. I like postfixing my test classes with <code>Should</code> to create a readable sentence with the test method name, but feel free to use your own style!</p>
</blockquote>
<p>The <code>TodoItemService</code> requires an <code>ApplicationDbContext</code>, which is normally connected to your development or live database. You won&apos;t want to use that for tests. Instead, you can use Entity Framework Core&apos;s in-memory database provider in your test code. Since the entire database exists in memory, it&apos;s wiped out every time the test is restarted. And, since it&apos;s a proper Entity Framework Core provider, the <code>TodoItemService</code> won&apos;t know the difference!</p>
<p>Use a <code>DbContextOptionsBuilder</code> to configure the in-memory database provider, and then make a call to <code>AddItem</code>:</p>
<pre><code class="lang-csharp"><span class="hljs-keyword">var</span> options = <span class="hljs-keyword">new</span> DbContextOptionsBuilder&lt;ApplicationDbContext&gt;()
    .UseInMemoryDatabase(databaseName: <span class="hljs-string">&quot;Test_AddNewItem&quot;</span>).Options;

<span class="hljs-comment">// Set up a context (connection to the DB) for writing</span>
<span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> inMemoryContext = <span class="hljs-keyword">new</span> ApplicationDbContext(options))
{
    <span class="hljs-keyword">var</span> service = <span class="hljs-keyword">new</span> TodoItemService(inMemoryContext);

    <span class="hljs-keyword">var</span> fakeUser = <span class="hljs-keyword">new</span> ApplicationUser
    {
        Id = <span class="hljs-string">&quot;fake-000&quot;</span>,
        UserName = <span class="hljs-string">&quot;fake@fake&quot;</span>
    };

    <span class="hljs-keyword">await</span> service.AddItemAsync(<span class="hljs-keyword">new</span> NewTodoItem { Title = <span class="hljs-string">&quot;Testing?&quot;</span> }, fakeUser);
}
</code></pre>
<p>The last line creates a new to-do item called <code>Testing?</code>, and tells the service to save it to the (in-memory) database. To verify that the business logic ran correctly, retrieve the item:</p>
<pre><code class="lang-csharp"><span class="hljs-comment">// Use a separate context to read the data back from the DB</span>
<span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> inMemoryContext = <span class="hljs-keyword">new</span> ApplicationDbContext(options))
{
    Assert.Equal(<span class="hljs-number">1</span>, <span class="hljs-keyword">await</span> inMemoryContext.Items.CountAsync());

    <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> inMemoryContext.Items.FirstAsync();
    Assert.Equal(<span class="hljs-string">&quot;Testing?&quot;</span>, item.Title);
    Assert.Equal(<span class="hljs-keyword">false</span>, item.IsDone);
    Assert.True(DateTimeOffset.Now.AddDays(<span class="hljs-number">3</span>) - item.DueAt &lt; TimeSpan.FromSeconds(<span class="hljs-number">1</span>));
}
</code></pre>
<p>The first verification step is a sanity check: there should never be more than one item saved to the in-memory database. Assuming that&apos;s true, the test retrieves the saved item with <code>FirstAsync</code> and then asserts that the properties are set to the expected values.</p>
<p>Asserting a datetime value is a little tricky, since comparing two dates for equality will fail if even the millisecond components are different. Instead, the test checks that the <code>DueAt</code> value is less than a second away from the expected value.</p>
<blockquote>
<p>Both unit and integration tests typically follow the AAA (Arrange-Act-Assert) pattern: objects and data are set up first, then some action is performed, and finally the test checks (asserts) that the expected behavior occurred.</p>
</blockquote>
<p>Here&apos;s the final version of the <code>AddNewItem</code> test:</p>
<p><strong><code>AspNetCoreTodo.UnitTests/TodoItemServiceShould.cs</code></strong></p>
<pre><code class="lang-csharp"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title">TodoItemServiceShould</span>
{
    [Fact]
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">async</span> Task <span class="hljs-title">AddNewItem</span>(<span class="hljs-params"></span>)
    </span>{
        <span class="hljs-keyword">var</span> options = <span class="hljs-keyword">new</span> DbContextOptionsBuilder&lt;ApplicationDbContext&gt;()
            .UseInMemoryDatabase(databaseName: <span class="hljs-string">&quot;Test_AddNewItem&quot;</span>)
            .Options;

        <span class="hljs-comment">// Set up a context (connection to the DB) for writing</span>
        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> inMemoryContext = <span class="hljs-keyword">new</span> ApplicationDbContext(options))
        {
            <span class="hljs-keyword">var</span> service = <span class="hljs-keyword">new</span> TodoItemService(inMemoryContext);
            <span class="hljs-keyword">await</span> service.AddItemAsync(<span class="hljs-keyword">new</span> NewTodoItem { Title = <span class="hljs-string">&quot;Testing?&quot;</span> }, <span class="hljs-keyword">null</span>);
        }

        <span class="hljs-comment">// Use a separate context to read the data back from the DB</span>
        <span class="hljs-keyword">using</span> (<span class="hljs-keyword">var</span> inMemoryContext = <span class="hljs-keyword">new</span> ApplicationDbContext(options))
        {
            Assert.Equal(<span class="hljs-number">1</span>, <span class="hljs-keyword">await</span> inMemoryContext.Items.CountAsync());

            <span class="hljs-keyword">var</span> item = <span class="hljs-keyword">await</span> inMemoryContext.Items.FirstAsync();
            Assert.Equal(<span class="hljs-string">&quot;Testing?&quot;</span>, item.Title);
            Assert.Equal(<span class="hljs-keyword">false</span>, item.IsDone);
            Assert.True(DateTimeOffset.Now.AddDays(<span class="hljs-number">3</span>) - item.DueAt &lt; TimeSpan.FromSeconds(<span class="hljs-number">1</span>));
        }
    }
}
</code></pre>
<h3 id="run-the-test"><a name="run-the-test" class="plugin-anchor" href="#run-the-test"><i class="fa fa-link" aria-hidden="true"></i></a>Run the test</h3>
<p>On the terminal, run this command (make sure you&apos;re still in the <code>AspNetCoreTodo.UnitTests</code> directory):</p>
<pre><code>dotnet test
</code></pre><p>The <code>test</code> command scans the current project for tests (marked with <code>[Fact]</code> attributes in this case), and runs all the tests it finds. You&apos;ll see an output similar to:</p>
<pre><code>Starting test execution, please wait...
[xUnit.net 00:00:00.7595476]   Discovering: AspNetCoreTodo.UnitTests
[xUnit.net 00:00:00.8511683]   Discovered:  AspNetCoreTodo.UnitTests
[xUnit.net 00:00:00.9222450]   Starting:    AspNetCoreTodo.UnitTests
[xUnit.net 00:00:01.3862430]   Finished:    AspNetCoreTodo.UnitTests

Total tests: 1. Passed: 1. Failed: 0. Skipped: 0.
Test Run Successful.
Test execution time: 1.9074 Seconds
</code></pre><p>You now have one test providing test coverage of the <code>TodoItemService</code>. As an extra-credit challenge, try writing unit tests that ensure:</p>
<ul>
<li><code>MarkDoneAsync</code> returns false if it&apos;s passed an ID that doesn&apos;t exist</li>
<li><code>MarkDoneAsync</code> returns true when it makes a valid item as complete</li>
<li><code>GetIncompleteItemsAsync</code> returns only the items owned by a particular user</li>
</ul>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: 自动化测试">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="integration-testing.html" class="navigation navigation-next " aria-label="Next page: 集成测试">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"单元测试","level":"1.8.1","depth":2,"next":{"title":"集成测试","level":"1.8.2","depth":2,"path":"chapters/automated-testing/integration-testing.md","ref":"chapters/automated-testing/integration-testing.md","articles":[]},"previous":{"title":"自动化测试","level":"1.8","depth":1,"path":"chapters/automated-testing/README.md","ref":"chapters/automated-testing/README.md","articles":[{"title":"单元测试","level":"1.8.1","depth":2,"path":"chapters/automated-testing/unit-testing.md","ref":"chapters/automated-testing/unit-testing.md","articles":[]},{"title":"集成测试","level":"1.8.2","depth":2,"path":"chapters/automated-testing/integration-testing.md","ref":"chapters/automated-testing/integration-testing.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["expandable-chapters-small","disqus","splitter","anchors","copy-code-button"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"disqus":{"useIdentifier":false,"shortName":"little-aspnetcore-book-cn"},"splitter":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"expandable-chapters-small":{},"copy-code-button":{},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{}},"theme":"default","author":"Nate Barbettini","pdf":{"pageNumbers":true,"fontSize":13,"fontFamily":"Microsoft YaHei","paperSize":"b5","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":12,"left":12,"top":12,"bottom":12,"comment_from_windsting":"these margin settings not working."}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"简明 ASP.NET Core 手册","language":"zh-hans","gitbook":"*","description":"一个关于“使用 ASP.NET Core 框架的构建 web 应用程序”的入门简介。"},"file":{"path":"chapters/automated-testing/unit-testing.md","mtime":"2017-11-28T07:32:28.332Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2017-11-28T08:45:05.947Z"},"basePath":"../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/URI.js/1.16.1/URI.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-disqus/plugin.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-copy-code-button/toggle.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

